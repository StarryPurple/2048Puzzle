<!--Generated by Google Gemini-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2048 Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px;
            background-color: #faf8ef;
            color: #776e65;
        }

        h1 {
            color: #776e65;
            font-size: 50px;
            margin: 0;
            margin-bottom: 10px;
        }

        #game-info {
            display: flex;
            width: 320px;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .score-container, .steps-container {
            background-color: #bbada0;
            color: #f9f6f2;
            padding: 5px 15px;
            border-radius: 3px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .score-container div, .steps-container div {
            font-size: 14px;
            font-weight: normal;
        }

        .game-container {
            display: grid;
            background-color: #bbada0;
            border-radius: 6px;
            padding: 5px;
            box-sizing: border-box;
        }

        .tile {
            width: 75px;
            height: 75px;
            background-color: #cdc1b4;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 35px;
            font-weight: bold;
            color: #776e65;
            border-radius: 3px;
        }

        .tile-2 { background-color: #eee4da; color: #776e65; }
        .tile-4 { background-color: #ede0c8; color: #776e65; }
        .tile-8 { background-color: #f2b179; color: #f9f6f2; }
        .tile-16 { background-color: #f59563; color: #f9f6f2; }
        .tile-32 { background-color: #f67c5f; color: #f9f6f2; }
        .tile-64 { background-color: #f65e3b; color: #f9f6f2; }
        .tile-128 { background-color: #edcf72; color: #f9f6f2; }
        .tile-256 { background-color: #edcc61; color: #f9f6f2; }
        .tile-512 { background-color: #edc850; color: #f9f6f2; }
        .tile-1024 { background-color: #edc53f; color: #f9f9f2; }
        .tile-2048 { background-color: #edc22e; color: #f9f6f2; }
        .tile-4096 { background-color: #555; color: #f9f6f2; font-size: 25px; }
        .tile-8192 { background-color: #333; color: #f9f6f2; font-size: 25px; }
        .tile-super { background-color: #3c3a32; color: #f9f6f2; font-size: 25px; }


        #gameStatus {
            margin-top: 15px;
            font-size: 20px;
            font-weight: bold;
        }

        #message {
            color: red;
            margin-top: 10px;
        }

        #bottom-controls {
            margin-top: 20px;
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-top: 1px solid #ccc;
        }

        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-group label {
            font-size: 16px;
            color: #776e65;
            white-space: nowrap;
        }

        .control-group input[type="number"] {
            padding: 8px;
            border: 1px solid #bbada0;
            border-radius: 4px;
            font-size: 16px;
            color: #776e65;
            background-color: #f9f6f2;
        }

        .control-group select {
            padding: 8px;
            border: 1px solid #bbada0;
            border-radius: 4px;
            font-size: 16px;
            color: #776e65;
            background-color: #f9f6f2;
        }

        .control-group button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background-color: #8f7a66;
            color: #f9f6f2;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .control-group button:hover {
            background-color: #998877;
        }

        #direction-buttons-container {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 15px;
            margin-bottom: 15px;
        }

        #direction-buttons {
            display: grid;
            grid-template-areas:
                ". up ."
                "left center right"
                ". down .";
            gap: 5px;
            width: 150px;
        }

        #direction-buttons button {
            padding: 15px;
            font-size: 18px;
            background-color: #8f7a66;
            color: #f9f6f2;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #direction-buttons button:hover {
            background-color: #998877;
        }

        #dir-up { grid-area: up; }
        #dir-left { grid-area: left; }
        #dir-right { grid-area: right; }
        #dir-down { grid-area: down; }

        #undoButtonAlone {
            padding: 15px 25px;
            font-size: 18px;
            background-color: #8f7a66;
            color: #f9f6f2;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            white-space: nowrap;
            height: 48px;
            line-height: 18px;
            box-sizing: border-box;
        }

        #undoButtonAlone:hover {
            background-color: #998877;
        }

        #aboutContent {
            white-space: pre-wrap;
            text-align: left;
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            max-width: 600px;
            margin-top: 20px;
            display: none;
            color: #776e65;
            border: 1px solid #bbada0;
        }

        /* Styles for sequence input */
        #sequence-control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #ccc;
            border-bottom: 1px solid #ccc;
            padding-bottom: 10px;
            border-top: 1px solid #ccc;
            width: 100%;
            max-width: 400px;
        }

        #sequenceInput {
            width: 90%;
            padding: 10px;
            border: 1px solid #bbada0;
            border-radius: 4px;
            font-size: 16px;
            color: #776e65;
            background-color: #f9f6f2;
            box-sizing: border-box;
        }

        #playSequenceButton {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background-color: #8f7a66;
            color: #f9f6f2;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #playSequenceButton:hover {
            background-color: #998877;
        }

        #delay-control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            font-size: 14px;
        }
        #delay-control-group input[type="number"] {
            width: 60px;
            text-align: center;
        }
        #about-control-group {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
<h1><span id="headerTargetDisplay">2048</span> Puzzle</h1>

<div id="game-info">
    <div class="score-container">
        Score
        <div id="scoreDisplay">0</div>
    </div>
    <div class="steps-container">
        Steps
        <div id="stepsDisplay">0</div>
    </div>
</div>

<div id="gameBoard" class="game-container"></div>

<p id="gameStatus"></p>
<p id="message"></p>

<div id="direction-buttons-container">
    <div id="direction-buttons">
        <button id="dir-up">▲</button>
        <button id="dir-left">◄</button>
        <button id="dir-right">►</button>
        <button id="dir-down">▼</button>
    </div>
    <button id="undoButtonAlone">Undo Last Move</button>
</div>


<div id="bottom-controls">
    <div class="control-group">
        <label for="rowsSelect">Rows:</label>
        <select id="rowsSelect">
            <script>
                for (let i = 1; i <= 10; i++) {
                    document.write(`<option value="${i}" ${i === 4 ? 'selected' : ''}>${i}</option>`);
                }
            </script>
        </select>
        <label for="colsSelect">Cols:</label>
        <select id="colsSelect">
            <script>
                for (let i = 1; i <= 10; i++) {
                    document.write(`<option value="${i}" ${i === 4 ? 'selected' : ''}>${i}</option>`);
                }
            </script>
        </select>
    </div>

    <div class="control-group">
        <label for="targetTileSelect">Target Tile:</label>
        <select id="targetTileSelect">
            <option value="8">8</option>
            <option value="16">16</option>
            <option value="32">32</option>
            <option value="64">64</option>
            <option value="128">128</option>
            <option value="256">256</option>
            <option value="512">512</option>
            <option value="1024">1024</option>
            <option value="2048" selected>2048</option>
            <option value="4096">4096</option>
            <option value="8192">8192</option>
        </select>
    </div>

    <div class="control-group">
        <label for="seedInput">Seed:</label>
        <input type="number" id="seedInput" placeholder="Enter seed" min="0">
        <input type="checkbox" id="randomSeedCheckbox" checked>
        <label for="randomSeedCheckbox">Random</label>
    </div>

    <div class="control-group">
        <button id="initButton">New Game</button>
    </div>

    <div class="control-group" style="font-size: 14px; margin-top: 5px;">
        <p>Current Seed: <span id="currentSeedDisplay">N/A</span></p>
        <p style="margin-left: 15px;">Selected Target: <span id="targetTileDisplay">2048</span></p>
    </div>
</div>

<div id="sequence-control-group">
    <input type="text" id="sequenceInput" placeholder="Paste wsadz sequence (e.g., wwssdaz)">
    <div id="delay-control-group">
        <label for="sequenceDelayInput">Step Delay (ms):</label>
        <input type="number" id="sequenceDelayInput" value="200" min="20">
    </div>
    <button id="playSequenceButton">Play Sequence</button>
</div>

<div id="about-control-group">
    <div class="control-group">
        <button id="aboutButton">About This Game</button>
    </div>
</div>

<div id="aboutContent"></div>

<script>
    const headerTargetDisplay = document.getElementById('headerTargetDisplay');
    const rowsSelect = document.getElementById('rowsSelect');
    const colsSelect = document.getElementById('colsSelect');
    const targetTileSelect = document.getElementById('targetTileSelect');
    const seedInput = document.getElementById('seedInput');
    const randomSeedCheckbox = document.getElementById('randomSeedCheckbox');
    const initButton = document.getElementById('initButton');
    const undoButton = document.getElementById('undoButtonAlone');
    const aboutButton = document.getElementById('aboutButton');

    const dirUpButton = document.getElementById('dir-up');
    const dirLeftButton = document.getElementById('dir-left');
    const dirRightButton = document.getElementById('dir-right');
    const dirDownButton = document.getElementById('dir-down');

    const sequenceInput = document.getElementById('sequenceInput');
    const playSequenceButton = document.getElementById('playSequenceButton');
    const sequenceDelayInput = document.getElementById('sequenceDelayInput'); // New

    const gameBoardDiv = document.getElementById('gameBoard');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const stepsDisplay = document.getElementById('stepsDisplay');
    const currentSeedDisplay = document.getElementById('currentSeedDisplay');
    const targetTileDisplay = document.getElementById('targetTileDisplay');
    const gameStatusDisplay = document.getElementById('gameStatus');
    const messageDiv = document.getElementById('message');
    const aboutContentDiv = document.getElementById('aboutContent');

    let currentRows = 4;
    let currentCols = 4;
    let isPlayingSequence = false; // New flag to prevent concurrent playback issues

    randomSeedCheckbox.addEventListener('change', () => {
        seedInput.disabled = randomSeedCheckbox.checked;
        if (randomSeedCheckbox.checked) {
            seedInput.value = '';
        }
    });

    seedInput.disabled = randomSeedCheckbox.checked;

    initButton.addEventListener('click', initGame);
    undoButton.addEventListener('click', undoMove);
    aboutButton.addEventListener('click', toggleAboutContent);
    dirUpButton.addEventListener('click', () => sendMove('w'));
    dirLeftButton.addEventListener('click', () => sendMove('a'));
    dirRightButton.addEventListener('click', () => sendMove('d'));
    dirDownButton.addEventListener('click', () => sendMove('s'));

    playSequenceButton.addEventListener('click', playSequence);

    document.addEventListener('keydown', handleKeyPress);

    async function initGame() {
        if (isPlayingSequence) {
            messageDiv.textContent = "Cannot start new game while sequence is playing.";
            return;
        }

        const rows = parseInt(rowsSelect.value);
        const cols = parseInt(colsSelect.value);
        const targetTile = parseInt(targetTileSelect.value);

        let seed = 0;
        if (!randomSeedCheckbox.checked) {
            const inputSeed = parseInt(seedInput.value);
            if (!isNaN(inputSeed) && inputSeed >= 0) {
                seed = inputSeed;
            } else {
                alert('Please enter a valid non-negative integer seed, or select random seed.');
                seedInput.value = '';
                randomSeedCheckbox.checked = true;
                seedInput.disabled = true;
                seed = 0;
            }
        }

        try {
            const requestBody = { rows: rows, cols: cols, target_tile: targetTile };
            if (randomSeedCheckbox.checked) {
                requestBody.seed = 0;
            } else {
                requestBody.seed = seed;
            }

            const response = await fetch('http://localhost:18080/init', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP Error! Status: ${response.status}, Message: ${errorText}`);
            }

            const data = await response.json();
            console.log("Game initialized:", data);

            updateDisplayFromData(data.board, data.score, data.steps, data.stuck, data.reached_2048, data.rows, data.cols, data.current_seed, data.target_tile);
            messageDiv.textContent = data.message;
        } catch (error) {
            console.error('Error initializing game:', error);
            messageDiv.textContent = `Error initializing game: ${error.message}. Please ensure the C++ backend is running.`;
        }
    }

    async function undoMove() {
        try {
            const response = await fetch('http://localhost:18080/undo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP Error! Status: ${response.status}, Message: ${errorText}`);
            }

            const data = await response.json();
            console.log("Undo result:", data);
            messageDiv.textContent = data.message;

            updateDisplayFromData(data.board, data.score, data.steps, data.stuck, data.reached_2048, data.rows, data.cols, data.current_seed, data.target_tile);
        } catch (error) {
            console.error('Error during undo operation:', error);
            messageDiv.textContent = `Error during undo operation: ${error.message}.`;
        }
    }

    async function handleKeyPress(event) {
        const targetTagName = event.target.tagName.toLowerCase();
        if (targetTagName === 'input' || targetTagName === 'textarea' || targetTagName === 'select') {
            return;
        }
        let direction = '';
        switch (event.key) {
            case 'w':
            case 'ArrowUp':
                direction = 'w';
                break;
            case 'a':
            case 'ArrowLeft':
                direction = 'a';
                break;
            case 's':
            case 'ArrowDown':
                direction = 's';
                break;
            case 'd':
            case 'ArrowRight':
                direction = 'd';
                break;
            case 'z':
                event.preventDefault();
                await undoMove();
                return;
        }

        if (direction) {
            event.preventDefault();
            await sendMove(direction);
        }
    }

    async function sendMove(direction) {
        try {
            const response = await fetch('http://localhost:18080/play', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ direction: direction })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP Error! Status: ${response.status}, Message: ${errorText}`);
            }

            const data = await response.json();
            console.log("Operation result:", data);

            let dir_info = "";
            switch (direction) {
                case 'w':
                    dir_info = "upward";
                    break;
                case 'a':
                    dir_info = "leftward";
                    break;
                case 's':
                    dir_info = "downward";
                    break;
                case 'd':
                    dir_info = "rightward";
                    break;
                default:
                    console.warn("Invalid direction in sendMove");
            }

            if (data.moved) {
                messageDiv.textContent = `Moved ${dir_info}.`;
            } else {
                messageDiv.textContent = `Cannot move ${dir_info}.`;
            }

            updateDisplayFromData(data.board, data.score, data.steps, data.stuck, data.reached_2048, data.rows, data.cols, data.current_seed, data.target_tile);
            return data.moved;
        }
        catch (error) {
            console.error('Error sending move operation:', error);
            messageDiv.textContent = `Error sending move operation: ${error.message}.`;
            return false;
        }
    }

    async function playSequence() {
        if (isPlayingSequence) {
            messageDiv.textContent = "A sequence is already playing.";
            return;
        }

        const sequence = sequenceInput.value.toLowerCase().trim();
        if (!sequence) {
            messageDiv.textContent = "Please enter a sequence to play.";
            return;
        }

        const delay = parseInt(sequenceDelayInput.value);
        if (isNaN(delay) || delay < 20) {
            messageDiv.textContent = "Invalid delay. Using default 200ms.";
            sequenceDelayInput.value = 200; // Reset to default if invalid
        }

        isPlayingSequence = true; // Set flag
        playSequenceButton.disabled = true;
        initButton.disabled = true; // Also disable new game during playback
        messageDiv.textContent = "Playing sequence...";

        for (let i = 0; i < sequence.length; i++) {
            const char = sequence[i];
            let handled = false;

            switch (char) {
                case 'w':
                case 'a':
                case 's':
                case 'd':
                    await sendMove(char);
                    handled = true;
                    break;
                case 'z':
                    await undoMove();
                    handled = true;
                    break;
                default:
                    console.warn(`Skipping unknown character in sequence: ${char}`);
                    messageDiv.textContent = `Skipping invalid char '${char}'...`;
                    break;
            }
            if (handled) {
                await new Promise(resolve => setTimeout(resolve, delay));
            } else if (char !== ' ') { // Only delay for non-space, non-handled characters
                await new Promise(resolve => setTimeout(resolve, 50)); // Small delay for ignored chars
            }
        }
        messageDiv.textContent = "Sequence playback finished.";
        isPlayingSequence = false; // Reset flag
        playSequenceButton.disabled = false;
        initButton.disabled = false;
    }


    function updateDisplayFromData(boardString, score, steps, stuck, reachedTarget, rows, cols, seed, target_tile) {
        currentRows = rows;
        currentCols = cols;
        gameBoardDiv.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        const boardWidth = cols * 75 + (cols + 1) * 5;
        const boardHeight = rows * 75 + (rows + 1) * 5;
        gameBoardDiv.style.width = `${boardWidth}px`;
        gameBoardDiv.style.height = `${boardHeight}px`;
        gameBoardDiv.innerHTML = '';

        const rowsArray = boardString.split('\n');
        rowsArray.forEach(rowString => {
            const tiles = rowString.split(' ').map(Number);
            tiles.forEach(tileValue => {
                const tileDiv = document.createElement('div');
                tileDiv.classList.add('tile');
                if (tileValue > 0) {
                    tileDiv.classList.add(`tile-${tileValue}`);
                    if (tileValue > 8192) {
                        tileDiv.classList.remove(`tile-${tileValue}`);
                        tileDiv.classList.add('tile-super');
                    }
                }
                tileDiv.textContent = tileValue === 0 ? '' : tileValue;
                gameBoardDiv.appendChild(tileDiv);
            });
        });

        headerTargetDisplay.textContent = target_tile;
        scoreDisplay.textContent = score;
        stepsDisplay.textContent = steps;
        currentSeedDisplay.textContent = seed;
        targetTileDisplay.textContent = target_tile;

        let statusText = '';
        if (reachedTarget) {
            statusText = 'Congratulations, you reached the target!';
            gameStatusDisplay.style.color = 'green';
        } else if (stuck) {
            statusText = 'Game Over! (No more moves)';
            gameStatusDisplay.style.color = 'red';
        } else {
            statusText = 'Game in progress';
            gameStatusDisplay.style.color = 'black';
        }
        gameStatusDisplay.textContent = statusText;
    }

    async function toggleAboutContent() {
        if (aboutContentDiv.style.display === 'block') {
            aboutContentDiv.style.display = 'none';
            aboutContentDiv.textContent = '';
        } else {
            try {
                const response = await fetch('http://localhost:18080/about');
                if (!response.ok) {
                    throw new Error(`HTTP Error! Status: ${response.status}`);
                }
                const text = await response.text();
                let aboutInfo = text;

                aboutInfo += "\n\n--- Seed Information ---\n";
                aboutInfo += "If 'Random' is checked, or if you enter '0' as the seed, the game will use a truly random (time-based) seed for generation. For reproducible games, uncheck 'Random' and enter a non-zero integer seed.\n";
                aboutInfo += "\n--- Controls ---\n";
                aboutInfo += "Keyboard: Use W, A, S, D or Arrow Keys for movement.\n";
                aboutInfo += "Press 'Z' to Undo the last move.\n";
                aboutInfo += "\n--- Control Sequence Information ---\n";
                aboutInfo += "Paste your \"wsadz\" sequence to simulate keyboard input.\n";
                aboutInfo += "You can choose the time interval per move.\n";
                aboutInfo += "Be aware that keyboard input is still available at executing the sequence and will jump into the queue.\n";

                aboutContentDiv.textContent = aboutInfo;
                aboutContentDiv.style.display = 'block';
            } catch (error) {
                console.error('Error fetching about content:', error);
                aboutContentDiv.textContent = `Could not load about content: ${error.message}`;
                aboutContentDiv.style.display = 'block';
            }
        }
    }

    initGame();

</script>
</body>
</html>